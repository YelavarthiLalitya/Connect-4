<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>4 in a Row</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  #board { display: grid; grid-template-columns: repeat(7, 50px); grid-gap: 5px; margin-top: 20px; }
  .cell { width: 50px; height: 50px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  .player0 { background: red; }
  .player1 { background: yellow; }
  .clickable { cursor: pointer; }
  table { margin-top: 20px; border-collapse: collapse; }
  th, td { padding: 5px 10px; border: 1px solid #000; }
</style>
</head>
<body>

<h2>4 in a Row</h2>
<label>Username: <input type="text" id="username" /></label>
<button id="joinBtn">Join Game</button>
<h3 id="status"></h3>
<div id="board"></div>
<h3>Winner: <span id="winner"></span></h3>

<h3>Leaderboard</h3>
<table id="leaderboard">
  <thead>
    <tr><th>Player</th><th>Wins</th></tr>
  </thead>
  <tbody></tbody>
</table>

<!-- keep your existing HTML; replace the <script> with this -->
<script>
const BACKEND_HOST = location.hostname;           // use same host as page
const BACKEND_PORT = 3000;                        // change if your server uses different port
const BACKEND_BASE = `http://${BACKEND_HOST}:${BACKEND_PORT}`;
const WS_URL = `ws://${BACKEND_HOST}:${BACKEND_PORT}`;

let ws = null;
let myPlayer = null;
let currentTurn = null;
let board = Array.from({ length: 6 }, () => Array(7).fill(null));

const boardDiv = document.getElementById('board');
const status = document.getElementById('status');
const winnerSpan = document.getElementById('winner');

function renderBoard() {
  boardDiv.innerHTML = '';
  for (let r = 0; r < 6; r++) {
    for (let c = 0; c < 7; c++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      if (board[r][c] === 0) cell.classList.add('player0');
      if (board[r][c] === 1) cell.classList.add('player1');

      // allow clicking any cell in top row to drop in that column when it's your turn
      if (r === 0 && currentTurn === myPlayer) {
        cell.classList.add('clickable');
        cell.onclick = () => {
          try {
            ws.send(JSON.stringify({ type: 'move', col: c }));
          } catch (e) {
            console.error('Failed to send move', e);
          }
        };
      }

      boardDiv.appendChild(cell);
    }
  }
}

// Determine current turn based on disc counts
function updateTurn() {
  const counts = {0:0, 1:0};
  board.flat().forEach(v => { if (v !== null) counts[v]++; });
  currentTurn = (counts[0] <= counts[1]) ? 0 : 1;
}

async function fetchLeaderboard() {
  try {
    const res = await fetch(`${BACKEND_BASE}/leaderboard`);
    const data = await res.json();
    const tbody = document.querySelector('#leaderboard tbody');
    tbody.innerHTML = '';
    data.forEach(player => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${player.username}</td><td>${player.wins}</td>`;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error('Failed to fetch leaderboard', err);
  }
}

document.getElementById('joinBtn').onclick = () => {
  const username = document.getElementById('username').value.trim();
  if (!username) return alert('Enter username');

  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    ws.send(JSON.stringify({ type: 'join', username }));
    status.innerText = 'Waiting for opponent...';
  };

  ws.onmessage = msg => {
    const data = JSON.parse(msg.data);

    if (data.type === 'start') {
      myPlayer = data.you;
      status.innerText = 'Game started! You are Player ' + myPlayer;
      updateTurn();
      renderBoard();
    }

    if (data.type === 'update') {
      board = data.board;
      updateTurn();
      renderBoard();
      status.innerText = currentTurn === myPlayer ? "Your turn" : "Opponent/Bot's turn";
    }

    if (data.type === 'end') {
      board = data.board || board;
      renderBoard();
      winnerSpan.innerText = data.winner || 'Draw';
      status.innerText = 'Game ended!';
      fetchLeaderboard(); // refresh leaderboard
    }
  };

  ws.onerror = (err) => {
    console.error('WebSocket error', err);
  };

  ws.onclose = () => {
    status.innerText = 'Disconnected from server';
  };

  renderBoard();
};

// Call on page load
fetchLeaderboard();
</script>


</body>
</html>
